<?xml version="1.0" encoding="utf-8"?>
<mdscript name="HeadHunterMD" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="md.xsd">
    <cues>
        <cue name="HHAttackTagger" instantiate="true">
            <conditions>
                <check_all>
                    <event_player_owned_attacked_object />
                    <check_value value="not event.param2.pilot.$beenattacked?" />
                    <check_value
                        value="event.param2.isclass.[class.ship_s,class.ship_m,class.ship_l,class.ship_xl]" />
                    <check_value value="event.param2.type != shiptype.distressdrone" />
                    <check_value value="event.param2.type != shiptype.escapepod" />
                    <check_value value="event.param2.type != shiptype.lasertower" />
                    <check_value value="event.param2.type != shiptype.smalldrone" />
                    <check_value value="event.param2.type != shiptype.xsdrone" />
                    <!--<check_value
                    value="not event.param.isclass.class.station" /> not sure yet if our stations
                    should count -->
                    <check_value value="not event.param2.isownerless" />
                    <check_value value="not event.param2.isplayerowned" />
                    <check_value value="event.param2.ishostileto.{faction.player}" />
                    <check_value value="event.param2.isoperational" />
                </check_all>
            </conditions>
            <actions>
                <set_value name="$HHDebug" exact="0" />
                <set_value name="$enemy" exact="event.param2" />
                <set_value name="$enemy.pilot.$beenattacked" exact="true" />
                <set_value name="$enemy.pilot.$attackedtime" exact="player.age" />
                <set_value name="$attacker" exact="event.param" />
                <set_value name="$enemyhealth" exact="$enemy.shield + $enemy.hull" />
                <set_value name="$reputationcalc" exact="(0.0064f / (2000000)f * ($enemyhealth)f)" />
                <signal_cue_instantly cue="Watcher" param="[event.param2, event.param]" />
            </actions>
        </cue>
        <cue name="Watcher" instantiate="true" namespace="this">
            <conditions>
                <event_cue_signalled />
            </conditions>
            <actions>
                <set_value name="$enemy" exact="event.param.{1}" />
                <set_value name="$attacker" exact="event.param.{2}" />
                <set_value name="$enemyhealthdeath" exact="$enemy.shield + $enemy.hull" />
            </actions>
            <cues>
                <cue name="DeathWatcher" instantiate="false"> <!-- sub cue -->
                    <conditions>
                        <event_object_destroyed object="$enemy" />
                    </conditions>
                    <actions>
                        <set_value name="$payer" exact="'The Intergalactic Bounty Fund'" />
                            <!-- Rep handling -->
                            <do_if value="$enemy.relationto.{$enemy.sector.trueowner} lt 0 and $enemy.sector.trueowner != faction.player">
                                <do_if value="$enemy.sector.trueowner.relationto.{faction.player} lt 1.0 ">
                                <add_faction_relation faction="faction.player"
                                    otherfaction="$enemy.sector.trueowner"
                                    value="HHAttackTagger.$reputationcalc"
                                    reason="relationchangereason.destroyedfactionenemy" />
                                </do_if>
                                <set_value name="$payer" exact="$enemy.sector.owner" />
                            </do_if>
                            <do_elseif
                                value="$enemy.relationto.{$enemy.sector.trueowner} lt 0 and $enemy.sector.trueowner == faction.player">
                                <debug_to_file name="'bounties'" directory="'HeadHunter'"
                                    text="'RELATION: Kill occured in: %s with sector owner: %s. %s relation to the owner is: %s. We already love ourselves so no relation change.'.[$enemy.sector.knownname,$enemy.sector.owner,$enemy.knownname,$enemy.relationto.{$enemy.sector.owner}]"
                                    output="false" append="true" chance="HHAttackTagger.$HHDebug" />
                            </do_elseif>
                            <!-- Bounty Handling -->
                            <do_if value="global.$HeadHunterBountyMultiplier != 0">
                                <set_value name="$reward" min="($enemyhealthdeath*0.3)i"
                                    max="($enemyhealthdeath*0.5)i" />
                                <set_value name="$rewardmodified" exact="$reward*global.$HeadHunterBountyMultiplier" />
                                <set_value name="$rewardCr" exact="($rewardmodified)Cr" />
                                <debug_to_file name="'bounties'" directory="'HeadHunter'"
                                    text="'%s got a bounty. Killed %s %s. Original Amount: %s Modified by BM: %s rewards %s total '.[$attacker.knownname,$enemy.knownname,$enemy.idcode,$reward,global.$HeadHunterBountyMultiplier,$rewardmodified]"
                                    output="false" append="true" chance="HHAttackTagger.$HHDebug" />
                                <write_to_logbook category="alerts"
                                    title="'Earned General Bounty'"
                                    text="'%s has paid a general bounty for the destruction of their enemy %s %s in the amount of %,s credits'.[$payer,$enemy.knownname,$enemy.idcode,$rewardmodified]"
                                    interaction="showonmap" object="$attacker" money="($rewardmodified)Cr" />
                                <transfer_money from="$enemy.sector.trueowner" to="faction.player"
                                    amount="$rewardCr" />
                            </do_if>
                        <cancel_cue cue="Watcher" />
                    </actions>
                </cue>
                <cue name="WatcherExpire" checkinterval="60s">
                    <conditions>
                        <check_value value="player.age - $enemy.pilot.$attackedtime ge 600s" />
                    </conditions>
                    <actions>
                        <debug_to_file name="'bounties'" directory="'HeadHunter'"
                                    text="'HHAttackTagger expired on %s %s. PlayerAge is %s and $attackedtime was %s'.[$enemy.idcode,$enemy.knownname,player.age,$enemy.pilot.$attackedtime]"
                                    output="false" append="true"
                                    chance="HHAttackTagger.$HHDebug" />
                        <remove_value name="$enemy.pilot.$beenattacked" />
                        <remove_value name="$enemy.pilot.$attackedtime" />
                        <cancel_cue cue="Watcher" />
                    </actions>
                </cue>
            </cues>
        </cue>
        <cue name="PapaCue" instantiate="true">
        <actions>
            <debug_text text="'HeadHunter PapaCue Activate. Ready to start tracking.'" />
            <create_group groupname="global.$HHAllShips" />
            <create_group groupname="global.$HHAllWanted" />
        </actions>
        <cues>
        <cue name="HHGatherTimer" instantiate="true" checkinterval="10s" checktime="player.age + 5s">
			<actions>
                <debug_to_file name="'wanted'" directory="'HeadHunter'"
                    text="'HHGatherTimer firing...'"
                    output="false" append="true" chance="0" />
				<signal_cue_instantly cue="GatherAllYeShips"/>
			</actions>
		</cue>
        <cue name="GatherAllYeShips" instantiate="true">
            <conditions><event_cue_signalled /></conditions>
            <actions>
                <find_ship space="player.galaxy" checkoperational="true" class="[class.ship_s,class.ship_m,class.ship_l,class.ship_xl]" functional="true" groupname="global.$HHAllShips" multiple="true" >
                    <match shiptype="shiptype.xsdrone" negate="true" />
                    <match shiptype="shiptype.escapepod" negate="true" />
                    <match shiptype="shiptype.distressdrone" negate="true" />
                    <match shiptype="shiptype.lasertower" negate="true" />
                    <match shiptype="shiptype.smalldrone" negate="true" />
                    <match owner="[faction.buccaneers,faction.civilian,faction.criminal,faction.khaak,faction.ownerless,faction.player,faction.scaleplate,faction.yaki,faction.xenon,faction.visitor]" negate="true" />
                </find_ship>
                <create_group groupname="global.$HHAllWanted" />
                <do_for_each name="$wantedshipship" in="global.$HeadHunterWantedTracker">
                    <do_if value="$wantedshipship.exists">
                        <add_to_group groupname="global.$HHAllWanted" object="$wantedshipship" />
                    </do_if>
                </do_for_each>
                <debug_to_file name="'wanted'" directory="'HeadHunter'"
                    text="'Gathering all ships in the galaxy! Total watching: %s Total Wanted: %s'.[global.$HHAllShips.count,global.$HHAllWanted.count]"
                    output="false" append="true" chance="0" />
            </actions>
        </cue>
        <cue name="WantedDestructionTracker" instantiate="true" >
                    <conditions>
                    <check_all>
                        <event_object_destroyed group="global.$HHAllShips" />
                        <check_value value="not global.$HHAllWanted.indexof.{event.param}"/> <!-- if a wanted ship is killed, we don't want to add the Wanted claimer to the wanted board. They should be left in peace for a job well done! -->
                        <check_value value="event.param.isclass.ship" />
                        <check_value value="not event.param.islasertower" />
                        <check_value value="event.object.isclass.ship"/> <!-- TODO: maybe temporary to doulecheck that victim is a ship -->
                        <check_any>
                            <check_value value="event.param.isclass.ship_s" />
                            <check_value value="event.param.isclass.ship_m" />
                            <check_value value="event.param.isclass.ship_l" />
                            <check_value value="event.param.isclass.ship_xl" />
                        </check_any>
                    </check_all>
                    </conditions>
                    <actions>
                        <set_value name="$victim" exact="event.object" />
                        <do_if value="event.param.typename == 'Drone'">
                            <debug_to_file name="'wanted'" directory="'HeadHunter'"
                            text="'\n%s was the killer so setting as commander: Vic: %s %s Real Killer: %s %s'.[@event.param.typename,event.object.idcode,event.object.knownname,event.param.commander.idcode,event.param.commander.knownname]"
                            output="false" append="true" chance="100" />
                            <do_if value="event.param.commander.isclass.ship"> <!-- Because lo and behold a station can get on the list if its drones kill somebody... --> 
                                <set_value name="$killer" exact="event.param.commander" />
                            </do_if>
                            <do_else><break /></do_else>
                        </do_if>
                        <do_else>
                            <set_value name="$killer" exact="event.param" />
                        </do_else>
                        <debug_to_file name="'wanted'" directory="'HeadHunter'"
                            text="'\nDestruction detected: VictimClass: %s Victim: %s %s Killer: %s %s \nKiller faction: %s Victim faction: %s \nShip value: %s'.[@$victim.class,@event.object.idcode,event.object.knownname,event.param.idcode,event.param.knownname,$killer.trueowner,$victim.trueowner,$victim.value.formatted.default]"
                            output="false" append="true" chance="0" />

                        <!-- Killer already on the board. Add the value -->
                        <do_if value="global.$HeadHunterWantedTracker.{$killer}?">
                            <debug_to_file name="'wanted'" directory="'HeadHunter'"
                            text="'SERIAL KILLER: Killer already on the board. Adding %s to %s'.[global.$HeadHunterWantedTracker.{$killer}.$value.formatted.default,$victim.value.formatted.default]"
                            output="false" append="true" chance="100" />
                            <set_value name="global.$HeadHunterWantedTracker.{$killer}.$value" exact="global.$HeadHunterWantedTracker.{$killer}.$value + ($victim.value - ($victim.seed % ($victim.value / 10)))" />
                            <set_value name="global.$HeadHunterWantedTracker.{$killer}.$lastvictim" exact="$victim" />
                            <set_value name="global.$HeadHunterWantedTracker.{$killer}.$lastseen" exact="$killer.sector" />
                            <debug_to_file name="'wanted'" directory="'HeadHunter'"
                            text="'New total is: %s'.[global.$HeadHunterWantedTracker.{$killer}.$value.formatted.default]"
                            output="false" append="true" chance="100" />
                        </do_if>
                        
                        <!-- Killer is new. Add to the board -->
                        <do_else>
                            <do_if value="($victim.value == null)">
                                <debug_to_file name="'wanted'" directory="'HeadHunter'"
                            text="'\nERROR: A victim value was null for some reason. Skipping.'.[@$killer.idcode,@$killer.knownname,@$victim.idcode,@$victim.knownname]"
                            output="false" append="true" chance="100" />
                                <break />
                            </do_if>
                            <set_value name="global.$HeadHunterWantedTracker.{$killer}" exact="table[$killer = $killer,$value = $victim.value - ($victim.seed % ($victim.value / 10)),$lastseen = $killer.sector,$lastvictim = $victim]" />
                            <debug_to_file name="'wanted'" directory="'HeadHunter'"
                            text="'NEW WANTED: Killer is brand new. Adding Killer: %s Value: %s to the board.'.[$killer.knownname,global.$HeadHunterWantedTracker.{$killer}.$value.formatted.default]"
                            output="false" append="true" chance="100" />
                        </do_else>
                    </actions>
            </cue>
        <cue name="WantedClaimTracker" instantiate="true">
            <conditions>
                <check_all>
                    <event_object_destroyed group="global.$HHAllWanted" />
                    <check_value value="event.param.knownname?" />
                </check_all>
            </conditions>
            <actions>
                <!-- TODO: temp debug to compare lists -->
                <do_for_each name="$temp" in="global.$HHAllWanted">
                    <debug_to_file name="'wanted'" directory="'HeadHunter'" text="'global.$HHAllWanted: %s %s'.[$temp.idcode,$temp.knownname]" output="false" append="true" chance="100" />
                </do_for_each>
                <do_for_each name="$temptwo" in="global.$HeadHunterWantedTracker">
                    <debug_to_file name="'wanted'" directory="'HeadHunter'" text="'$HeadHunterWantedTracker: %s %s'.[$temptwo.idcode,$temptwo.knownname]" output="false" append="true" chance="100" />
                </do_for_each>

                <set_value name="$wantedship" exact="event.object"/>
                <set_value name="$wantedclaimer" exact="event.param"/>
                <set_value name="$claimsector" exact="$wantedship.sector.knownname" />
                <debug_to_file name="'wanted'" directory="'HeadHunter'"
                    text="'CLAIM: A Wanted ship has been destroyed in %s: %s %s that had a bounty on their head of %s'.[$claimsector,event.object.idcode,event.object.knownname,global.$HeadHunterWantedTracker.{$wantedship}.$value.formatted.default]"
                    output="false" append="true" chance="100" />
                <do_if value="global.$HeadHunterNotify or $wantedclaimer.isplayerowned">
				    <show_notification text="'Head Claimed! %s %s was destroyed in %s by %s\nBounty value: %s credits'.[$wantedship.idcode,$wantedship.knownname,$claimsector,$wantedclaimer.knownname,global.$HeadHunterWantedTracker.{$wantedship}.$value.formatted.default]" priority="1" />
                <write_to_logbook category="alerts"
                        title="'HEAD CLAIMED:'"
                        text="'%s %s was destroyed in %s by %s\nBounty value: %s credits'.[$wantedship.idcode,$wantedship.knownname,$claimsector,$wantedclaimer.knownname,global.$HeadHunterWantedTracker.{$wantedship}.$value.formatted.default]"
                        interaction="showonmap" object="$wantedship" money="if $wantedship.isplayerowned then ($wantedship.$value)Cr else null" />
                </do_if>
                <do_if value="$wantedclaimer.isplayerowned">
                    <speak actor="player.computer" line="279" comment="Incoming funds transfer." />
                    <transfer_money from="global.$HeadHunterWantedTracker.{$wantedship}.$lastvictim.owner" to="faction.player" amount="(global.$HeadHunterWantedTracker.{$wantedship}.$value)Cr" /> <!-- determine here what percentage we are setting the actual reward to, or start showing the actual reward in the bounty menu and give that straight up -->
                    <add_faction_relation faction="faction.player" otherfaction="global.$HeadHunterWantedTracker.{$wantedship}.$lastvictim.owner" value="0.00016LF + (0.0064LF / (2000000)LF * (global.$HeadHunterWantedTracker.{$wantedship}.$value)LF)" reason="relationchangereason.destroyedfactionenemy" />
                </do_if>
                <remove_value name="global.$HeadHunterWantedTracker.{$wantedship}" />

                <!-- TODO: verify money transfer on wanted kill -->
                <!-- TODO: gravidar scans aren't working -->
                <!-- TODO: player ship on wanted kill is added to the wanted list...do we want to do this right now? -->
                <!-- TODO: change gatherallyeships interval to reasonable level -->
                <!-- TODO: just for testing 503:X detected 279:incoming funds transfer 511:X within sensor range 513+10044: Bounty Hunter on intercept course (for player bounty thing later) 302224401:Target acquired 302224520:Proximity alert -->
                <!-- TODO: track bounty on player.entity. Send job ships to hunt player. As bounty grows, send stronger shit -->
            </actions>
         </cue>
         <cue name="ProximityThrottle" instantiate="true" checktime="player.age + 30s" checkinterval="30s" comment="Else comming across a ship, gravidar apparently ">
         <actions>
            <set_value name="global.$HHThrottled" exact="false" />
         </actions>
         </cue>
         <cue name="WantedPlayerProximity" instantiate="true" comment="Stuff for wanted within player ship range">
            <conditions>
                <check_all>
                    <event_gravidar_has_scanned group="global.$PlayerControlledGroup"/>
                    <check_value value="event.object.sector and event.object == player.ship" />
                    <check_value value="not @global.$HHThrottled" />
                    <count_gravidar_contacts result="$contacts" object="event.object" min="1" multiple="true">
                        <match_context macro="event.object.sector.macro" />
                        <match class="class.ship" />
                        <match shiptype="shiptype.xsdrone" negate="true" />
                        <match shiptype="shiptype.lasertower" negate="true" />
                        <match shiptype="shiptype.smalldrone" negate="true" />
                    </count_gravidar_contacts>
                </check_all>
            </conditions>
            <actions>
                <do_for_each name="$contact" in="$contacts" counter="$counter">
                    <do_if value="global.$HeadHunterWantedTracker.{$contact}? and $counter le 1" comment="So as not to spam if there is a fleet of badasses">
                        <speak actor="player.computer" line="[2021,511]" />
                        <show_notification text="[['Wanted Ship Nearby!\n%s %s worth %s credits'.[$contact.idcode,$contact.knownname,global.$HeadHunterWantedTracker.{$contact}.$value.formatted.default],179,102,255]]" priority="90" />
                        <set_value name="global.$HHThrottled" exact="true" />
                        
                        <break />
                    </do_if>
                </do_for_each>
            </actions>
         </cue>
         <cue name="WantedPlayerShipsProximity" instantiate="true" comment="Stuff for wanted within player owned ships range">
            <conditions>
                <check_all>
                    <event_gravidar_has_scanned group="global.$PlayerControlledGroup"/>
                    <check_value value="event.object.sector and event.object != player.ship" />
                    <count_gravidar_contacts result="$contacts" object="event.object" min="1" multiple="true">
                        <match_context macro="event.object.sector.macro" />
                        <match class="class.ship" />
                    </count_gravidar_contacts>
                </check_all>
            </conditions>
            <actions>
                <do_for_each name="$contact" in="$contacts" counter="$counter">
                    <do_if value="global.$HHAllWanted.indexof.{$contact} and $counter le 1" comment="same as above about badasses">
                        <speak actor="event.object.assignedaipilot" line="10503" comment="Wingman reporting enemy activity."/>
                        <write_to_logbook category="alerts" title="'Wanted Ship Spotted!'"
                                    text="'Our fleet has spotted a ship with a Wanted Bounty in %s worth %s credits.'.[$contact.sector,global.$HeadHunterWantedTracker.{$contact}.$value.formatted.default]"
                                    interaction="showonmap" object="$contact" />
                    </do_if>
                </do_for_each>
            </actions>
         </cue>
         </cues>
        </cue>
    </cues>
</mdscript>